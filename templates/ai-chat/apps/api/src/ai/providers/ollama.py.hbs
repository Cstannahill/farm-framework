"""Ollama local model provider."""
from typing import AsyncGenerator, List
import os
import httpx
from .base import AIProvider, ChatMessage

OLLAMA_URL = os.getenv("OLLAMA_URL", "http://localhost:11434")

class OllamaProvider(AIProvider):
    async def chat(self, messages: List[ChatMessage], model: str, **kwargs) -> str:
        async with httpx.AsyncClient() as client:
            resp = await client.post(
                f"{OLLAMA_URL}/api/chat",
                json={"model": model, "messages": [m.dict() for m in messages]},
            )
            resp.raise_for_status()
            data = resp.json()
            return data.get("message", {}).get("content", "")

    async def chat_stream(self, messages: List[ChatMessage], model: str, **kwargs) -> AsyncGenerator[str, None]:
        async with httpx.AsyncClient() as client:
            async with client.stream(
                "POST",
                f"{OLLAMA_URL}/api/chat",
                json={"model": model, "stream": True, "messages": [m.dict() for m in messages]},
            ) as resp:
                resp.raise_for_status()
                async for line in resp.aiter_lines():
                    if line.startswith("data: "):
                        yield line[6:]

    async def list_models(self) -> List[str]:
        async with httpx.AsyncClient() as client:
            resp = await client.get(f"{OLLAMA_URL}/api/tags")
            resp.raise_for_status()
            data = resp.json()
            return [m["name"] for m in data.get("models", [])]
